networks:
  2024_summer_coding:
    name: 2024_summer_coding_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1
    labels:
      com.docker.compose.network: '2024_summer_coding'
      com.docker.compose.project: '2024_summer_coding'
    external: false

# swarm 모드에서는 overlay 를 사용해야한다.
#networks:
#  2024_summer_coding:
#    driver: overlay

services:
  mysqldb:
    image: mysql:latest
    container_name: mysqldb
    environment:
      MYSQL_ROOT_PASSWORD: '=dl-13579'
      MYSQL_DATABASE: '2024_summer_coding'
    volumes:
      - ../mysql-data:/var/lib/mysql
    ports:
      - 3306:3306
    networks:
      - 2024_summer_coding

  redisdb:
    image: redis:latest
    container_name: redisdb
    volumes:
      - ../redis-data:/data
    ports:
      - 6379:6379
    networks:
      - 2024_summer_coding

  springboot:
    image: springboot:latest
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysqldb:3306/2024_summer_coding?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: =dl-13579
      SPRING__PROFILES_ACTIVE: docker
#    deploy:
#      replicas: 3
    networks:
      - 2024_summer_coding
    depends_on:
      - mysqldb
      - redisdb

# 외부포트 열면 에러 발생 -> 포트 중복
# scale out 시점에 다른 사설 Ip 주소 할당받고 모두 8080 포트 사용하게된다.
# 웹서버인 Nginx 로 접근

# 컨테이너명도 설정하면 컨테이너명 중복되어 에러발생한다.

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ../prometheus-data:/prometheus
      - ../prometheus:/etc/prometheus
    ports:
      - 9090:9090
    networks:
      - 2024_summer_coding
    depends_on:
      - springboot

  influxdb:
    image: influxdb:1.8.5
    container_name: influxdb
    environment:
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_HTTP_AUTH_ENABLED=false
      - INFLUXDB_DB= admin
    volumes:
      - ../influxdb-data:/var/lib/influxdb
    ports:
      - 8086:8086
      - 8088:8088
    networks:
      - 2024_summer_coding

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    volumes:
      - ../grafana-data:/var/lib/grafana
    ports:
      - 3000:3000
    networks:
      - 2024_summer_coding
    depends_on:
      - prometheus

  nginx:
    image: nginx:latest
    container_name: nginx
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../nginx/conf.d/:/etc/nginx/conf.d
    ports:
      - 80:80
      - 443:443
    networks:
      - 2024_summer_coding
    depends_on:
      - springboot
    restart: always